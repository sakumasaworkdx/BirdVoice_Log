<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bird Voice Spectrogram WaveTone風タイムライン v2.5.2</title>
  <style>
    :root{
      --bg:#0b0f17; --panel:#0f1624; --panel2:#0d1320;
      --text:#e9eef7; --muted:#a9b5c9; --line:rgba(255,255,255,.10);
      --accent:#5eead4; --danger:#ff6b6b; --shadow:0 16px 40px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", Helvetica, Arial;
    }
    html,body{height:100%;}
    body{
      margin:0; font-family:var(--sans);
      background: radial-gradient(1200px 800px at 25% 10%, rgba(94,234,212,.12), transparent 55%),
                  radial-gradient(900px 600px at 85% 20%, rgba(125,211,252,.10), transparent 55%),
                  linear-gradient(180deg, var(--bg), #05070c);
      color:var(--text);
    }
    .wrap{max-width:1320px; margin:0 auto; padding:22px 16px 36px;}
    header{
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between;
      padding:14px 16px; border:1px solid var(--line); border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
    }
    h1{margin:0; font-size:18px; letter-spacing:.2px}
    .sub{margin-top:6px; color:var(--muted); font-size:13px; line-height:1.4}
    .badges{display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end}
    .badge{
      padding:6px 10px; border-radius:999px;
      background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12);
      color:var(--muted); font-weight:800; font-size:12px;
    }
    .mono{font-family:var(--mono)}
    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:end}
    .panel{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panel .head{
      padding:12px 14px; border-bottom:1px solid var(--line);
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      background: rgba(0,0,0,.12);
    }
    .panel .body{padding:14px; display:grid; gap:12px;}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px; border-radius:999px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      font-size:12px; color:var(--muted); font-weight:800;
    }
    .field{display:grid; gap:6px;}
    .field label{font-size:12px; color:var(--muted); font-weight:800}
    input, select, button{
      font:inherit; color:var(--text);
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
    }
    input[type="file"]{padding:10px;}
    input:focus, select:focus{border-color:rgba(94,234,212,.55); box-shadow:0 0 0 3px rgba(94,234,212,.15);}
    button{
      cursor:pointer; font-weight:900;
      background: linear-gradient(180deg, rgba(94,234,212,.20), rgba(94,234,212,.06));
      border-color: rgba(94,234,212,.35);
    }
    button.secondary{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.14);
      color:var(--text);
    }
    button.danger{
      background: linear-gradient(180deg, rgba(255,107,107,.22), rgba(255,107,107,.06));
      border-color: rgba(255,107,107,.45);
    }
    button:disabled{opacity:.45; cursor:not-allowed}
    .grid{
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr 1fr;}
      header{flex-direction:column; align-items:stretch}
      .badges{justify-content:flex-start}
    }
    .split{
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){ .split{grid-template-columns:1fr;} }

    /* timeline */
    .timeline{
      border:1px solid var(--line); border-radius:var(--radius);
      background: rgba(0,0,0,.14);
      overflow:hidden;
    }
    .viewport{
      position:relative;
      overflow:auto;
      height: 520px;
      background: rgba(0,0,0,.14);
    }
    canvas{display:block;}
    .footerrow{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between}
    .bar{height:10px; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden; border:1px solid rgba(255,255,255,.10)}
    .bar > div{height:100%; width:0%; background: linear-gradient(90deg, rgba(94,234,212,.80), rgba(125,211,252,.85));}

    /* side list */
    .side{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .side .head{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.10);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .side .body{ padding:12px; display:grid; gap:10px; }
    .list{
      border:1px solid var(--line);
      border-radius:12px;
      background: rgba(0,0,0,.14);
      max-height: 360px;
      overflow:auto;
    }
    .hit{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
    }
    .hit:hover{ background: rgba(255,255,255,.06); }
    .hit:last-child{ border-bottom:none; }
    .hit .t{ font-weight:900; }
    .hit .v{ color: var(--muted); font-size:12px; }
    .btnrow{ display:flex; gap:8px; flex-wrap:wrap; }
    .mini{ padding:8px 10px; border-radius:10px; font-size:12px; font-weight:900; }

    pre#log{
      margin:0; padding:12px 14px;
      background: rgba(0,0,0,.22);
      border-top:1px solid var(--line);
      color: #c7d2fe;
      font-size:12px;
      max-height: 180px;
      overflow:auto;
      font-family:var(--mono);
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Bird Voice Spectrogram — WaveTone風タイムライン <span class="mono">v2.5.2</span></h1>
      <div class="sub">
        巨大ファイル対応（ビューポート描画＋タイルキャッシュ） / クリックでシーク再生 / 赤線が再生位置<br>
        <b>重要:</b> <span class="mono">index.html</span> と <span class="mono">script.js</span> を必ずセットで上書き（片方だけだとボタンが反応しない原因になります）
      </div>
    </div>
    <div class="badges">
      <span class="badge">色マップ</span>
      <span class="badge">対数周波数</span>
      <span class="badge">帯域強調</span>
      <span class="badge">検出マーカー</span>
      <span class="badge">PNG保存（表示/範囲）</span>
      <span class="badge">検出スキャン（再利用で高速）</span>
    </div>
  </header>

  <section class="panel">
    <div class="head">
      <span class="pill">1) ファイル読み込み / 準備</span>
      <span class="pill mono" id="state">未準備</span>
    </div>
    <div class="body">
      <div class="grid">
        <div class="field">
          <label>音声ファイル（MP3/WAV）</label>
          <input id="fileInput" type="file" accept="audio/*" />
        </div>
        <div class="field">
          <label>タイル秒（解析単位）</label>
          <input id="tileSec" type="number" min="2" max="20" step="1" value="5" />
        </div>
        <div class="field">
          <label>解析FPS（横解像度）</label>
          <input id="fps" type="number" min="5" max="120" step="1" value="30" />
        </div>
        <div class="field">
          <label>FFTサイズ</label>
          <select id="fftSize">
            <option>1024</option>
            <option selected>2048</option>
            <option>4096</option>
            <option>8192</option>
          </select>
        </div>

        <div class="field">
          <label>表示上限Hz</label>
          <input id="maxHz" type="number" min="1000" max="24000" step="100" value="12000" />
        </div>
        <div class="field">
          <label>dBレンジ（min / max）</label>
          <div class="row">
            <input id="minDb" type="number" min="-120" max="-20" step="1" value="-100" style="width:120px">
            <input id="maxDb" type="number" min="-80" max="0" step="1" value="-20" style="width:120px">
          </div>
        </div>
        <div class="field">
          <label>色マップ</label>
          <select id="cmap">
            <option>Turbo</option>
            <option>Magma</option>
            <option>Viridis</option>
            <option selected>Grayscale</option>
          </select>
        </div>
        <div class="field">
          <label>周波数軸</label>
          <select id="freqScale">
            <option value="linear">linear</option>
            <option value="log" selected>log</option>
          </select>
        </div>

        <div class="field">
          <label>ズーム（px/秒）</label>
          <input id="pxPerSec" type="number" min="30" max="400" step="10" value="120" />
        </div>
        <div class="field">
          <label>キャッシュタイル数</label>
          <input id="cacheTiles" type="number" min="10" max="400" step="10" value="120" />
        </div>
        <div class="field">
          <label>鳥帯域強調（Hz）</label>
          <div class="row">
            <input id="hlMinHz" type="number" min="0" max="24000" step="100" value="2500" style="width:120px">
            <input id="hlMaxHz" type="number" min="0" max="24000" step="100" value="9000" style="width:120px">
          </div>
        </div>
        <div class="field">
          <label>PNG範囲(s)</label>
          <div class="row">
            <input id="exportStartSec" type="number" min="0" step="1" value="0" style="width:120px">
            <input id="exportEndSec" type="number" min="0" step="1" value="30" style="width:120px">
          </div>
        </div>
      </div>

      <div class="row">
        <button id="prepareBtn">読み込み/準備</button>
        <button id="playBtn" class="secondary" disabled>再生</button>
        <button id="pauseBtn" class="secondary" disabled>一時停止</button>
        <button id="stopBtn" class="secondary" disabled>停止</button>
        <button id="clearBtn" class="danger">リセット</button>
        <span class="pill mono" id="meta">-</span>
      </div>

      <div class="footerrow">
        <div style="flex:1; min-width: 220px;">
          <div class="bar"><div id="progFill"></div></div>
        </div>
        <div class="row">
          <button id="exportViewBtn" class="secondary" disabled>PNG保存（表示中）</button>
          <button id="exportRangeBtn" class="secondary" disabled>PNG保存（範囲）</button>
          <span class="pill mono" id="tileInfo">tile: -</span>
        </div>
      </div>

      <audio id="fullAudio" controls style="width:100%"></audio>
    </div>
    <pre id="log"></pre>
  </section>

  <div class="split" style="margin-top:14px">
    <section class="timeline">
      <div class="head" style="padding:12px 14px; border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center; gap:12px; background: rgba(0,0,0,.12);">
        <span class="pill">2) ロング・スペクトログラム（スクロール）</span>
        <span class="pill mono" id="viewportInfo">view: -</span>
      </div>
      <div class="viewport" id="viewport">
        <canvas id="specCanvas" width="1200" height="520"></canvas>
      </div>
    </section>

    <div class="side" id="detectPanel">
      <div class="head">
        <span class="pill">検出箇所リスト（クリックでジャンプ）</span>
        <span class="pill mono" id="detectCount">0件</span>
      </div>
      <div class="body">
        <div class="field">
          <label>検出帯域(Hz)</label>
          <div class="row">
            <input id="scanMinHz" type="number" min="0" max="24000" step="100" value="3000" style="width:120px" />
            <span class="pill">〜</span>
            <input id="scanMaxHz" type="number" min="0" max="24000" step="100" value="12000" style="width:120px" />
          </div>
        </div>

        <div class="field">
          <label>閾値(dB)</label>
          <input id="scanThresholdDb" type="number" min="-120" max="0" step="1" value="-55" />
        </div>

        <div class="field">
          <label>ステップ(s)</label>
          <input id="scanStepSec" type="number" min="0.1" max="2.0" step="0.1" value="0.5" />
        </div>

        <div class="btnrow">
          <button class="mini secondary" id="presetSmallBird">小鳥(3kHz〜)</button>
          <button class="mini secondary" id="presetRaptor">猛禽(1.5kHz〜)</button>
          <button class="mini secondary" id="presetAll">全帯域(0Hz〜)</button>
        </div>

        <div class="btnrow">
          <button class="mini" id="scanBtn" disabled>スキャン開始</button>
          <button class="mini danger" id="scanStopBtn" disabled>停止</button>
        </div>

        <div class="bar"><div id="scanBarFill"></div></div>
        <div class="pill mono" id="scanStatus">scan: -</div>

        <div class="list" id="detectList"></div>
      </div>
    </div>
  </div>

</div>
<script src="./script.js"></script>
</body>
</html>
